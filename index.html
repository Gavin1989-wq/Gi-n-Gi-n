<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coi vận mệnh — Chat</title>
<style>
  :root{
    --bg:#ffffff; --card:#ffffff; --muted:#6b7280; --accent:#ff6b8a;
    --accent-2:#ff9ab0;
    --bubble-bot:#f1f5f9; --bubble-user:#0b1220; --user-text:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI",Roboto,Arial;background:var(--bg);color:#0b1220;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:28px}
  .container{width:100%;max-width:880px;border-radius:12px;padding:18px;border:1px solid #eee;box-shadow:0 8px 30px rgba(15,23,42,0.06);background:#fff}
  .topbar{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .logo{width:44px;height:44px;border-radius:8px;overflow:hidden;flex-shrink:0;display:inline-flex;align-items:center;justify-content:center}
  .logo img{width:100%;height:100%;object-fit:cover;display:block}
  .brand{font-weight:800;font-size:18px}
  .note-small{font-size:13px;color:var(--muted);margin-bottom:12px}
  .chat{background:#fafafa;border-radius:12px;padding:18px;min-height:420px;max-height:62vh;overflow:auto;border:1px solid #f0f0f0}
  .msg{display:flex;gap:12px;margin-bottom:12px;align-items:flex-start}
  .msg.bot{align-items:flex-start}
  .msg.user{justify-content:flex-end}
  .avatar{width:40px;height:40px;border-radius:8px;overflow:hidden;flex-shrink:0}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .bubble{max-width:78%;padding:10px 12px;border-radius:12px;line-height:1.45}
  .bubble.bot{background:var(--bubble-bot);color:#0b1220;border:1px solid #e8eef6;border-bottom-left-radius:6px}
  .bubble.user{background:var(--bubble-user);color:var(--user-text);border-bottom-right-radius:6px}
  .small{font-size:13px;color:var(--muted);margin-top:6px}
  .controls{display:flex;gap:8px;margin-top:12px}
  input[type="text"], input[type="number"]{flex:1;padding:10px;border-radius:10px;border:1px solid #eee;font-size:14px}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;padding:9px 12px;border-radius:10px;color:#fff;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid #eee;color:var(--muted)}
  .hidden{display:none !important}
  .result{margin-top:12px;padding:10px;border-radius:10px;background:#fff;border:1px solid #eee;white-space:pre-wrap}
  #confettiCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9999}

  /* loader: dots animation */
  .thinking-row{display:flex;align-items:center;gap:10px}
  .thinking-label{font-size:13px;color:var(--muted);font-weight:600}
  .dots{display:inline-flex;gap:6px;align-items:center}
  .dot{width:8px;height:8px;border-radius:50%;background:#9aa7bf;opacity:0.25}
  .dot.anim{animation:fade 900ms infinite ease-in-out}
  .dot.anim:nth-child(2){animation-delay:120ms}
  .dot.anim:nth-child(3){animation-delay:240ms}
  @keyframes fade{0%{opacity:0.25;transform:translateY(0)}50%{opacity:0.9;transform:translateY(-4px)}100%{opacity:0.25;transform:translateY(0)}}

  @media (max-width:720px){
    .container{padding:12px}
    .chat{min-height:360px}
  }
</style>
</head>
<body>
<canvas id="confettiCanvas"></canvas>

<div class="container">
  <div class="topbar">
    <div class="logo" title="Giòn Giòn (logo)">
      <img src="logo.png" alt="logo">
    </div>
    <div>
      <div class="brand">Giòn Giòn</div>
      <div class="note-small">Ghi chú: đổi 2 bạn trùng tên thành <strong>Mngoc</strong> (26/01) và <strong>Bella</strong> (18/05).</div>
    </div>
  </div>

  <div id="chat" class="chat" aria-live="polite">
    <div id="initialBot" class="msg bot">
      <div class="avatar"><img src="logo.png" alt="avatar"></div>
      <div class="bubble bot">
        <strong>Xin chào!</strong><br>
        Bạn muốn biết đường tình duyên, đường học vấn, etc... không? Nếu có <strong>hãy điền họ tên của bạn vào!</strong>
        <div class="small">Gõ tên chính xác (không phân biệt dấu) và nhấn Enter hoặc "Gửi tên".</div>
      </div>
    </div>
  </div>

  <div id="nameControls" class="controls" style="margin-top:12px">
    <input id="nameInput" type="text" placeholder="Nhập họ và tên của bạn...">
    <button id="sendNameBtn" class="btn">Gửi tên</button>
    <button id="retryBtn" class="btn ghost hidden">Làm lại</button>
  </div>

  <div id="alwaysControls" class="controls" style="margin-top:12px">
    <button id="clearBtn" class="btn ghost">Xóa</button>
  </div>

  <div id="numberControls" class="controls hidden" style="margin-top:12px">
    <input id="numInput" type="number" min="1" max="999" placeholder="Chọn 1 con số (1–999)">
    <button id="sendNumBtn" class="btn">Gửi số</button>
  </div>

  <div id="playWrap" class="controls hidden" style="margin-top:10px">
    <button id="playMusicBtn" class="btn ghost">Phát nhạc sinh nhật</button>
  </div>
</div>

<audio id="happyAudio" src="happy.mp3" preload="auto"></audio>

<script>
/* ---------------- helpers ---------------- */
function normalizeName(s){
  return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D').toLowerCase().replace(/\s+/g,' ').trim();
}
function parseDob(ddmm){ const [d,m]=ddmm.split('/').map(x=>parseInt(x,10)); return {day:d,month:m}; }
function localMidnight(date){ const t=new Date(date); t.setHours(0,0,0,0); return t; }
function computeDaysForThisYear(day,month,today=new Date()){
  const t = localMidnight(today);
  const y = t.getFullYear();
  let bd = new Date(y, month-1, day);
  if (bd.getMonth() !== (month-1)) {
    if (month===2 && day===29) bd = new Date(y,1,28);
  }
  bd = localMidnight(bd);
  if(bd.getTime()===t.getTime()) return {isBirthdayToday:true,passed:false,days:0};
  if(bd.getTime() < t.getTime()) { const days = Math.floor((t - bd)/86400000); return {isBirthdayToday:false,passed:true,days}; }
  else { const days = Math.ceil((bd - t)/86400000); return {isBirthdayToday:false,passed:false,days}; }
}

/* ---------------- data: updated (Mngoc & Bella) ---------------- */
const RAW_LIST = [
  { name: "Nguyễn Nghi Quỳnh", dob: "05/01" },
  { name: "Trần Minh Bảo Hân", dob: "29/03" },
  { name: "Nguyễn Trí Tường", dob: "19/01" },
  { name: "Tô Dương Bảo Khánh", dob: "04/07" },
  { name: "Mngoc", dob: "26/01" },           // replaced
  { name: "Cao Ngọc Kim Thư", dob: "07/02" },
  { name: "Lương Mai Trang", dob: "06/11" },
  { name: "Bella", dob: "18/05" },           // replaced
  { name: "Trần Hồng Ân", dob: "31/03" },
  { name: "Nguyễn Phạm Thuý Uyên", dob: "12/05" },
  { name: "Cao Ngọc Thiên Kim", dob: "10/05" },
  { name: "Tô Dương Bảo Khánh", dob: "04/07" },
  { name: "Nguyễn Ngọc Phương Nhi", dob: "10/02" },
  { name: "Bùi Hoàng Quân", dob: "17/08" },
  { name: "Nguyễn Ngọc Ngân Hà", dob: "05/04" },
  { name: "Phạm Vũ Bảo Ngọc", dob: "25/07" },
  { name: "Trương Hoàng Tấn Dũng", dob: "04/02" },
  { name: "Nguyễn Minh Đăng", dob: "03/12" },
  { name: "Phạm Quỳnh Hương", dob: "07/12" },
  { name: "Nguyễn Nhựt Minh", dob: "14/08" },
  { name: "Đoàn Minh Thư", dob: "03/07" },
  { name: "Nguyễn Hải Điền", dob: "21/05" },
  { name: "Hồ Mai Phương", dob: "03/11" },
  { name: "Đặng Quang Thiện", dob: "01/03" },
  { name: "Đặng Hoàng Linh Chi", dob: "10/09" },
  { name: "Châu Khả Ái", dob: "03/02" },
  { name: "Nguyễn Duy Hoàng", dob: "08/01" },
  { name: "Đoàn Thể Tần", dob: "04/11" },
  { name: "Ngô Bảo Khoa", dob: "09/05" },
  { name: "Lê Cát Khuê Anh", dob: "13/10" },
  { name: "Trương Tiến Phát", dob: "16/08" },
  { name: "Bùi Quỳnh Anh", dob: "19/10" },
  { name: "Nguyễn Đặng Hoàng Lê", dob: "25/08" },
  { name: "Phùng Thị Lan Phương", dob: "13/05" },
  { name: "Nguyễn Ngọc Huy Khang", dob: "06/07" },
  { name: "Lê Nguyễn Khánh Lynh", dob: "08/08" }
];

/* ---------------- DOM refs ---------------- */
const chat = document.getElementById('chat');
const initialBot = document.getElementById('initialBot');
const nameControls = document.getElementById('nameControls');
const nameInput = document.getElementById('nameInput');
const sendNameBtn = document.getElementById('sendNameBtn');
const clearBtn = document.getElementById('clearBtn');
const retryBtn = document.getElementById('retryBtn');

const numberControls = document.getElementById('numberControls');
const numInput = document.getElementById('numInput');
const sendNumBtn = document.getElementById('sendNumBtn');

const playWrap = document.getElementById('playWrap');
const playMusicBtn = document.getElementById('playMusicBtn');
const happyAudio = document.getElementById('happyAudio');

/* ---------------- confetti ---------------- */
const confettiCanvas = document.getElementById('confettiCanvas');
const confCtx = confettiCanvas.getContext && confettiCanvas.getContext('2d');
let confDPR = window.devicePixelRatio || 1;
function confResize(){ if(!confCtx) return; confettiCanvas.width = window.innerWidth*confDPR; confettiCanvas.height = window.innerHeight*confDPR; confettiCanvas.style.width = window.innerWidth+'px'; confettiCanvas.style.height = window.innerHeight+'px'; confCtx.setTransform(confDPR,0,0,confDPR,0,0); }
if(confCtx){ confResize(); window.addEventListener('resize', confResize); }
function confettiBurst(count=120){
  if(!confCtx) return;
  const parts=[];
  const colors=['#ff5a8f','#ffd166','#6df0ff','#6a9bff','#a8ffb0'];
  for(let i=0;i<count;i++){ parts.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight*0.12,vx:(Math.random()-0.5)*8,vy:Math.random()*6+2,w:Math.random()*8+4,color:colors[Math.floor(Math.random()*colors.length)],ttl:80+Math.random()*60}); }
  (function loop(){ confCtx.clearRect(0,0,window.innerWidth,window.innerHeight); for(let i=parts.length-1;i>=0;i--){ const p=parts[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.12; p.ttl--; confCtx.fillStyle=p.color; confCtx.fillRect(p.x,p.y,p.w,p.w*0.6); if(p.ttl<=0||p.y>window.innerHeight+50) parts.splice(i,1); } if(parts.length>0) requestAnimationFrame(loop); else confCtx.clearRect(0,0,window.innerWidth,window.innerHeight); })();
}

/* ---------------- audio control ---------------- */
function stopAudio(){
  try{ happyAudio.pause(); happyAudio.currentTime = 0; }catch(e){}
  if (playWrap) playWrap.classList.add('hidden');
}

/* ---------------- chat helpers ---------------- */
function appendBot(text){
  const m = document.createElement('div'); m.className='msg bot';
  const av = document.createElement('div'); av.className='avatar'; av.innerHTML = '<img src="logo.png" alt="bot">';
  const bubble = document.createElement('div'); bubble.className='bubble bot'; bubble.innerHTML = text;
  m.appendChild(av); m.appendChild(bubble);
  chat.appendChild(m); chat.scrollTop = chat.scrollHeight;
  return m;
}
function appendUser(text){
  const m = document.createElement('div'); m.className='msg user';
  const bubble = document.createElement('div'); bubble.className = 'bubble user'; bubble.textContent = text;
  m.appendChild(bubble); chat.appendChild(m); chat.scrollTop = chat.scrollHeight;
  return m;
}

/* ---------------- loader (dots) ---------------- */
function makeLoaderBubble(label = 'Giòn Giòn đang suy nghĩ'){
  const m = document.createElement('div');
  m.className = 'msg bot';
  const av = document.createElement('div'); av.className = 'avatar'; av.innerHTML = '<img src="logo.png" alt="Giòn Giòn">';
  const bubble = document.createElement('div'); bubble.className = 'bubble bot';
  const row = document.createElement('div'); row.className = 'thinking-row';
  const lab = document.createElement('div'); lab.className = 'thinking-label'; lab.textContent = label;
  const dots = document.createElement('span'); dots.className = 'dots';
  for(let i=0;i<3;i++){ const d = document.createElement('span'); d.className = 'dot anim'; dots.appendChild(d); }
  row.appendChild(lab); row.appendChild(dots); bubble.appendChild(row);
  m.appendChild(av); m.appendChild(bubble);
  chat.appendChild(m); chat.scrollTop = chat.scrollHeight;
  chat.setAttribute('aria-busy', 'true');
  return m;
}
function randDelayMs(){ return 3000 + Math.floor(Math.random()*2000); }

/* ---------------- main flow ---------------- */
let selectedPerson = null;
let lastAction = null;

function disableControlsDuringSend(disabled){
  nameInput.disabled = disabled;
  sendNameBtn.disabled = disabled;
  clearBtn.disabled = disabled;
  numInput.disabled = disabled;
  sendNumBtn.disabled = disabled;
  retryBtn.disabled = disabled;
  playMusicBtn.disabled = disabled;
}

/* name submit */
async function handleNameSubmit(){
  stopAudio();
  const val = (nameInput.value||'').trim();
  if(!val) return;
  const norm = normalizeName(val);
  const hits = RAW_LIST.filter(p => normalizeName(p.name) === norm);

  if(initialBot) { initialBot.remove(); }
  appendUser(val);
  nameInput.value='';

  disableControlsDuringSend(true);
  const loader = makeLoaderBubble('Giòn Giòn đang suy nghĩ...');
  lastAction = { type: 'name', payload: val, hits: hits };
  await new Promise(r => setTimeout(r, randDelayMs()));
  loader.remove(); chat.removeAttribute('aria-busy');

  if(hits.length === 0){
    appendBot('<strong>Vui lòng nhập lại họ tên của bạn</strong>');
    disableControlsDuringSend(false);
    retryBtn.classList.remove('hidden'); retryBtn.disabled = false;
    return;
  }
  if(hits.length === 1){
    selectedPerson = hits[0];
    nameControls.classList.add('hidden');
    numberControls.classList.remove('hidden');
    appendBot('Ok <strong>' + selectedPerson.name + '</strong> — ok vậy <em>chọn 1 con số từ 1 - 999 đi</em>');
    disableControlsDuringSend(false);
    retryBtn.classList.remove('hidden'); retryBtn.disabled = false;
    return;
  }
  const container = appendBot('Mình tìm thấy nhiều người cùng tên, chọn đúng ngày sinh của bạn:');
  const wrap = document.createElement('div'); wrap.style.marginTop = '8px';
  hits.forEach(h=>{
    const btn = document.createElement('button'); btn.className='btn ghost'; btn.style.margin='4px 6px 0 0';
    btn.textContent = h.dob + ' — ' + h.name;
    btn.addEventListener('click', ()=>{
      selectedPerson = h;
      wrap.remove();
      nameControls.classList.add('hidden');
      numberControls.classList.remove('hidden');
      appendBot('Đã chọn: <strong>' + h.name + ' — ' + h.dob + '</strong>');
      appendBot('Ok vậy chọn 1 con số từ 1 - 999 đi');
    });
    wrap.appendChild(btn);
  });
  container.appendChild(wrap);
  disableControlsDuringSend(false);
  retryBtn.classList.remove('hidden'); retryBtn.disabled = false;
}

/* number submit: 2-stage loader with dots (3-5s then 2-3s) */
async function handleNumberSubmit(){
  const raw = numInput.value;
  const n = Number(raw);
  if(!raw || isNaN(n) || n<1 || n>999){ appendBot('<strong>Hãy nhập một số hợp lệ từ 1 đến 999.</strong>'); return; }

  appendUser(String(n)); numInput.value='';
  if(!selectedPerson){ appendBot('Chưa chọn người — quay lại nhập tên.'); nameControls.classList.remove('hidden'); numberControls.classList.add('hidden'); return; }

  lastAction = { type:'number', payload: n, person: selectedPerson };
  disableControlsDuringSend(true);

  // Stage 1: wait 3-5s with dots animation
  const loader1 = makeLoaderBubble('Giòn Giòn đang suy nghĩ...');
  await new Promise(r => setTimeout(r, randDelayMs()));
  loader1.remove();

  // Stage 2: wait 2-3s with dots animation
  const loader2 = makeLoaderBubble('Giòn Giòn đang kiểm tra thêm...');
  await new Promise(r => setTimeout(r, 2000 + Math.floor(Math.random()*1000)));
  loader2.remove();
  chat.removeAttribute('aria-busy');

  // result logic (same as before)
  const {day,month} = parseDob(selectedPerson.dob);
  const comp = computeDaysForThisYear(day,month,new Date());
  const days = comp.days;
  let outLines = [];

  if(comp.isBirthdayToday){
    try{ happyAudio.play(); }catch(e){ if (playWrap) playWrap.classList.remove('hidden'); }
    confettiBurst(200);
    const upper = selectedPerson.name.toLocaleUpperCase('vi');
    outLines = ['MEL MEL MEL CHÚC MỪNG SINH NHẬT ' + upper + ' MĂM MĂM RỘP RỘP!!!!!', '(Bạn đã nhập: ' + n + ')'];
  } else {
    confettiBurst(120);
    if(comp.passed){
      if(n === days){
        outLines = ['Mình sẽ giải đáp con số đó\n\nCon số đó là số ngày kể từ ngày sinh nhật của cậu ('+days+' ngày), dù sao thì chúc mừng nhe<3'];
      } else {
        outLines = ['Con số này ko liên quan nhưng mà đã qua '+days+' (số ngày) kể từ sinh nhật bạn rồi'];
      }
    } else {
      if(n === days){
        outLines = ['Ten tèn ten, con số bạn chọn chính là còn '+days+' (số ngày) nữa sẽ tới sinh nhật bạn rồi, congratulations!!!'];
      } else {
        outLines = ['Uhm thôi kệ số đó đi, còn '+days+' (số ngày) nữa sẽ tới sinh nhật bạn rồi, hẹ hẹ hẹ'];
      }
    }
  }

  appendBot(outLines.join('\n\n'));
  if(playWrap) playWrap.classList.remove('hidden');
  disableControlsDuringSend(false);
  retryBtn.classList.remove('hidden'); retryBtn.disabled = false;
}

/* retry */
retryBtn.addEventListener('click', async ()=>{
  if(!lastAction) return;
  retryBtn.disabled = true;
  if(lastAction.type === 'name'){
    disableControlsDuringSend(true);
    const loader = makeLoaderBubble('Giòn Giòn đang suy nghĩ...');
    await new Promise(r => setTimeout(r, randDelayMs()));
    loader.remove(); chat.removeAttribute('aria-busy');

    const val = lastAction.payload;
    const hits = RAW_LIST.filter(p => normalizeName(p.name) === normalizeName(val));
    if(hits.length === 0) appendBot('<strong>Vui lòng nhập lại họ tên của bạn</strong>');
    else if(hits.length === 1){
      selectedPerson = hits[0];
      nameControls.classList.add('hidden');
      numberControls.classList.remove('hidden');
      appendBot('Ok <strong>' + selectedPerson.name + '</strong> — ok vậy <em>chọn 1 con số từ 1 - 999 đi</em>');
    } else {
      const container = appendBot('Mình tìm thấy nhiều người cùng tên, chọn đúng ngày sinh của bạn:');
      const wrap = document.createElement('div'); wrap.style.marginTop = '8px';
      hits.forEach(h=>{
        const btn = document.createElement('button'); btn.className='btn ghost'; btn.style.margin='4px 6px 0 0';
        btn.textContent = h.dob + ' — ' + h.name;
        btn.addEventListener('click', ()=>{ selectedPerson = h; wrap.remove(); nameControls.classList.add('hidden'); numberControls.classList.remove('hidden'); appendBot('Đã chọn: <strong>' + h.name + ' — ' + h.dob + '</strong>'); appendBot('Ok vậy chọn 1 con số từ 1 - 999 đi'); });
        wrap.appendChild(btn);
      });
      container.appendChild(wrap);
    }
    disableControlsDuringSend(false);
    retryBtn.disabled = false;
  } else if(lastAction.type === 'number'){
    disableControlsDuringSend(true);
    const loader1 = makeLoaderBubble('Giòn Giòn đang suy nghĩ...');
    await new Promise(r => setTimeout(r, randDelayMs()));
    loader1.remove();
    const loader2 = makeLoaderBubble('Giòn Giòn đang kiểm tra thêm...');
    await new Promise(r => setTimeout(r, 2000 + Math.floor(Math.random()*1000)));
    loader2.remove();
    chat.removeAttribute('aria-busy');

    const n = lastAction.payload;
    const selected = lastAction.person;
    if(!selected){ appendBot('Chưa chọn người — quay lại nhập tên.'); nameControls.classList.remove('hidden'); numberControls.classList.add('hidden'); disableControlsDuringSend(false); retryBtn.disabled = false; return; }

    const {day,month} = parseDob(selected.dob);
    const comp = computeDaysForThisYear(day,month,new Date());
    const days = comp.days;
    let outLines = [];

    if(comp.isBirthdayToday){
      try{ happyAudio.play(); }catch(e){ if (playWrap) playWrap.classList.remove('hidden'); }
      confettiBurst(200);
      const upper = selected.name.toLocaleUpperCase('vi');
      outLines = ['MEL MEL MEL CHÚC MỪNG SINH NHẬT ' + upper + ' MĂM MĂM RỘP RỘP!!!!!', '(Bạn đã nhập: ' + n + ')'];
    } else {
      confettiBurst(120);
      if(comp.passed){
        if(n === days) outLines = ['Mình sẽ giải đáp con số đó\n\nCon số đó là số ngày kể từ ngày sinh nhật của cậu ('+days+' ngày), dù sao thì chúc mừng nhe<3'];
